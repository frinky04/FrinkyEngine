name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-release-win:
    name: build-release-win
    runs-on: windows-latest
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x
          cache: true
          cache-dependency-path: |
            **/*.csproj
            Directory.Build.props

      - name: Validate tag and capture version
        id: meta
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          if ($tag -notmatch "^v(\d+)\.(\d+)\.(\d+)$") {
            throw "Tag '$tag' does not match required format vMAJOR.MINOR.PATCH."
          }

          $version = "$($Matches[1]).$($Matches[2]).$($Matches[3])"
          "tag=$tag" >> $env:GITHUB_OUTPUT
          "version=$version" >> $env:GITHUB_OUTPUT

      - name: Restore dotnet tools
        run: dotnet tool restore

      - name: Restore solution (win-x64)
        run: dotnet restore FrinkyEngine.sln -r win-x64

      - name: Publish editor (win-x64)
        run: >
          dotnet publish src/FrinkyEngine.Editor/FrinkyEngine.Editor.csproj
          -c Release
          -r win-x64
          --self-contained false
          -o artifacts/release/editor/win-x64

      - name: Publish runtime template for editor export (win-x64)
        run: >
          dotnet publish src/FrinkyEngine.Runtime/FrinkyEngine.Runtime.csproj
          -c Release
          -r win-x64
          --self-contained true
          -p:PublishSingleFile=true
          -p:IncludeNativeLibrariesForSelfExtract=true
          -p:FrinkyExport=true
          -o artifacts/release/editor/win-x64/RuntimeTemplate

      - name: Publish runtime (win-x64)
        run: >
          dotnet publish src/FrinkyEngine.Runtime/FrinkyEngine.Runtime.csproj
          -c Release
          -r win-x64
          --self-contained false
          -p:FrinkyExport=true
          -o artifacts/release/runtime/win-x64

      - name: Publish Core for API doc generation
        run: >
          dotnet publish src/FrinkyEngine.Core/FrinkyEngine.Core.csproj
          -c Release
          -o artifacts/apidoc-stage

      - name: Generate API documentation
        run: >
          dotnet xmldoc2md
          artifacts/apidoc-stage/FrinkyEngine.Core.dll
          -o docs/api
          --github-pages

      - name: Commit API docs to main
        shell: pwsh
        run: |
          # Save generated docs to temp location
          Copy-Item -Path docs/api -Destination $env:RUNNER_TEMP/api-docs -Recurse

          # Fetch and checkout main
          git fetch origin main
          git checkout main

          # Copy generated docs into the working tree
          if (Test-Path docs/api) { Remove-Item -Recurse -Force docs/api }
          Copy-Item -Path $env:RUNNER_TEMP/api-docs -Destination docs/api -Recurse

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add --force docs/api
          $status = git status --porcelain docs/api
          if ($status) {
            git commit -m "docs: Regenerate API reference for ${{ steps.meta.outputs.tag }}"
            git push origin main
          } else {
            Write-Host "No API doc changes to commit."
          }
        continue-on-error: true

      - name: Verify release publish outputs
        shell: pwsh
        run: |
          $required = @(
            "artifacts/release/editor/win-x64/FrinkyEngine.Editor.exe",
            "artifacts/release/editor/win-x64/Shaders/lighting.vs",
            "artifacts/release/editor/win-x64/EditorAssets/Fonts/JetBrains_Mono/static/JetBrainsMono-Regular.ttf",
            "artifacts/release/editor/win-x64/RuntimeTemplate/FrinkyEngine.Runtime.exe",
            "artifacts/release/runtime/win-x64/FrinkyEngine.Runtime.exe",
            "artifacts/release/runtime/win-x64/Shaders/lighting.vs"
          )

          foreach ($path in $required) {
            if (-not (Test-Path $path)) {
              throw "Missing required release file: $path"
            }
          }

      - name: Create release archives
        shell: pwsh
        run: |
          $version = "${{ steps.meta.outputs.version }}"
          $editorDir = "artifacts/release/editor/win-x64"
          $runtimeDir = "artifacts/release/runtime/win-x64"

          $editorStage = "artifacts/release/FrinkyEngine-Editor-win-x64-v$version"
          $runtimeStage = "artifacts/release/FrinkyEngine-Runtime-win-x64-v$version"

          New-Item -ItemType Directory -Force -Path $editorStage | Out-Null
          New-Item -ItemType Directory -Force -Path $runtimeStage | Out-Null

          Copy-Item -Path "$editorDir/*" -Destination $editorStage -Recurse -Force
          Copy-Item -Path "$runtimeDir/*" -Destination $runtimeStage -Recurse -Force

          $editorZip = "artifacts/release/FrinkyEngine-Editor-win-x64-v$version.zip"
          $runtimeZip = "artifacts/release/FrinkyEngine-Runtime-win-x64-v$version.zip"

          if (Test-Path $editorZip) { Remove-Item $editorZip -Force }
          if (Test-Path $runtimeZip) { Remove-Item $runtimeZip -Force }

          Compress-Archive -Path "$editorStage/*" -DestinationPath $editorZip -CompressionLevel Optimal
          Compress-Archive -Path "$runtimeStage/*" -DestinationPath $runtimeZip -CompressionLevel Optimal

      - name: Upload release archives
        uses: actions/upload-artifact@v6
        with:
          name: release-zips
          path: |
            artifacts/release/FrinkyEngine-Editor-win-x64-v${{ steps.meta.outputs.version }}.zip
            artifacts/release/FrinkyEngine-Runtime-win-x64-v${{ steps.meta.outputs.version }}.zip
          if-no-files-found: error

  create-github-release:
    name: create-github-release
    runs-on: ubuntu-latest
    needs:
      - build-release-win

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install git-cliff
        uses: taiki-e/install-action@v2
        with:
          tool: git-cliff@2.7.0

      - name: Generate release notes
        id: cliff
        run: |
          {
            echo 'changelog<<EOF'
            git-cliff --current --strip header
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Download release archives
        uses: actions/download-artifact@v7
        with:
          name: release-zips
          path: artifacts/release

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-release-win.outputs.tag }}
          name: FrinkyEngine ${{ needs.build-release-win.outputs.tag }}
          body: ${{ steps.cliff.outputs.changelog }}
          files: |
            artifacts/release/FrinkyEngine-Editor-win-x64-v${{ needs.build-release-win.outputs.version }}.zip
            artifacts/release/FrinkyEngine-Runtime-win-x64-v${{ needs.build-release-win.outputs.version }}.zip
